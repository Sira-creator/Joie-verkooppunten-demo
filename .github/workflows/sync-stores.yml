name: Sync Stores from Google Sheets

on:
  schedule:
    # Draait elke dag om 6:00 UTC
    - cron: '0 6 * * *'
  workflow_dispatch:  # Maakt handmatige uitvoering mogelijk

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install pandas openpyxl requests

      - name: Fetch and convert Google Sheet to JSON
        env:
          GOOGLE_SHEET_ID: ${{ secrets.GOOGLE_SHEET_ID }}
        run: |
          python << 'EOF'
          import pandas as pd
          import json
          import os

          # Haal Google Sheet ID op uit environment variable
          sheet_id = os.environ.get('GOOGLE_SHEET_ID')
          if not sheet_id:
              raise ValueError("GOOGLE_SHEET_ID is niet ingesteld in GitHub Secrets")

          # Construeer de export URL (CSV formaat)
          # Vervang 'stores_corrected' door de naam van je sheet tab indien anders
          sheet_name = 'stores_corrected'
          url = f'https://docs.google.com/spreadsheets/d/{sheet_id}/gviz/tq?tqx=out:csv&sheet={sheet_name}'

          # Lees de spreadsheet
          df = pd.read_csv(url)

          # Converteer naar JSON met meertalige ondersteuning
          stores = []
          for _, row in df.iterrows():
              store = {
                  'name': row['Store Name'],
                  'address': row['Address'],
                  'postalCode': str(row['Postal Code']),
                  'city': row['City'],
                  'country': row['Country'],
                  'website': row['Website'],
                  'category': row['Category'],
                  'lat': float(row['Latitude']),
                  'lng': float(row['Longitude'])
              }
              
              # Voeg Place ID toe indien aanwezig
              if pd.notna(row.get('Place ID')) and str(row['Place ID']).strip():
                  store['place_id'] = str(row['Place ID'])
              
              # Voeg Franse vertalingen toe indien aanwezig
              if 'Store Name FR' in row and pd.notna(row['Store Name FR']):
                  store['name_fr'] = row['Store Name FR']
              if 'Address FR' in row and pd.notna(row['Address FR']):
                  store['address_fr'] = row['Address FR']
              if 'City FR' in row and pd.notna(row['City FR']):
                  store['city_fr'] = row['City FR']
              if 'Category FR' in row and pd.notna(row['Category FR']):
                  store['category_fr'] = row['Category FR']
              
              stores.append(store)

          # Schrijf naar JSON bestand
          with open('stores.json', 'w', encoding='utf-8') as f:
              json.dump(stores, f, ensure_ascii=False, indent=2)

          print(f"âœ“ Succesvol {len(stores)} winkels gesynchroniseerd")
          EOF

      - name: Commit and push if changed
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'actions@github.com'
          git add stores.json
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto-update stores.json from Google Sheets" && git push)
